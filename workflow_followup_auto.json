{"name": "SP3 - Motor de Follow-up (Auto)", "nodes": [{"parameters": {"rule": {"interval": [{"field": "minutes", "minutesInterval": 1}]}}, "type": "n8n-nodes-base.scheduleTrigger", "typeVersion": 1, "position": [100, 300], "id": "trigger-id", "name": "A cada 1 minuto"}, {"parameters": {"operation": "executeQuery", "query": "SELECT * FROM sp3chat WHERE ia_active = true AND ( (followup_stage = 0 AND last_outbound_at < NOW() - INTERVAL '10 minutes') OR (followup_stage = 1 AND last_outbound_at < NOW() - INTERVAL '30 minutes') OR (followup_stage = 2 AND last_outbound_at < NOW() - INTERVAL '60 minutes') ) AND last_inbound_at < last_outbound_at LIMIT 10;", "options": {}}, "type": "n8n-nodes-base.postgres", "typeVersion": 2, "position": [320, 300], "id": "fetch-leads-id", "name": "Buscar Leads Silenciosos", "credentials": {"postgres": {"id": "Q9Iztik7LneSMpvU", "name": "SP3 CHAT - SUPABASE"}}}, {"parameters": {"rules": {"values": [{"conditions": {"options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 2}, "conditions": [{"leftValue": "={{ $json.followup_stage }}", "rightValue": 0, "operator": {"type": "number", "operation": "equal"}, "id": "cond-1"}], "combinator": "and"}, "renameOutput": true, "outputKey": "Follow 1"}, {"conditions": {"options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 2}, "conditions": [{"id": "cond-2", "leftValue": "={{ $json.followup_stage }}", "rightValue": 1, "operator": {"type": "number", "operation": "equal"}}], "combinator": "and"}, "renameOutput": true, "outputKey": "Follow 2"}, {"conditions": {"options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 2}, "conditions": [{"id": "cond-3", "leftValue": "={{ $json.followup_stage }}", "rightValue": 2, "operator": {"type": "number", "operation": "equal"}}], "combinator": "and"}, "renameOutput": true, "outputKey": "Follow 3"}]}, "options": {}}, "type": "n8n-nodes-base.switch", "typeVersion": 3.2, "position": [540, 300], "id": "switch-stage-id", "name": "Qual Etapa?"}, {"parameters": {"assignments": {"assignments": [{"id": "msg-1", "name": "mensagem", "value": "Oi! Passando para ver se conseguiu ler minha Ãºltima mensagem? ðŸ‘€", "type": "string"}, {"id": "next-1", "name": "next_stage", "value": 1, "type": "number"}]}, "options": {}}, "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [800, 150], "id": "set-f1-id", "name": "Msg Follow 1"}, {"parameters": {"assignments": {"assignments": [{"id": "msg-2", "name": "mensagem", "value": "Ainda por aÃ­? Se preferir, podemos marcar um papo rÃ¡pido para eu tirar suas dÃºvidas! ðŸ“²", "type": "string"}, {"id": "next-2", "name": "next_stage", "value": 2, "type": "number"}]}, "options": {}}, "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [800, 300], "id": "set-f2-id", "name": "Msg Follow 2"}, {"parameters": {"assignments": {"assignments": [{"id": "msg-3", "name": "mensagem", "value": "Vi que as coisas devem estar corridas! Vou deixar nosso link de agenda aqui para quando vocÃª puder: [LINK]. ðŸ¤", "type": "string"}, {"id": "next-3", "name": "next_stage", "value": 3, "type": "number"}]}, "options": {}}, "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [800, 450], "id": "set-f3-id", "name": "Msg Follow 3"}, {"parameters": {"method": "POST", "url": "=https://evo.sp3company.shop/message/sendText/v1", "authentication": "genericCredentialType", "genericAuthType": "httpHeaderAuth", "sendBody": true, "bodyParameters": {"parameters": [{"name": "number", "value": "={{ $json.telefone }}"}, {"name": "text", "value": "={{ $json.mensagem }}"}]}, "options": {}}, "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.2, "position": [1100, 300], "id": "send-msg-id", "name": "Enviar Follow-up", "credentials": {"httpHeaderAuth": {"id": "lm3lTu0WoowRIHHa", "name": "SP3CHAT - EVOLUTION API"}}}, {"parameters": {"operation": "update", "tableId": "sp3chat", "updateKey": "telefone", "fieldsUi": {"fieldValues": [{"fieldId": "followup_stage", "fieldValue": "={{ $json.next_stage }}"}, {"fieldId": "last_outbound_at", "fieldValue": "={{ $now }}"}]}}, "type": "n8n-nodes-base.supabase", "typeVersion": 1, "position": [1350, 300], "id": "update-db-id", "name": "Atualizar Kanban", "credentials": {"supabaseApi": {"id": "DsTq5kkfhqj2VdXo", "name": "SP3CHAT"}}}], "connections": {"A cada 1 minuto": {"main": [[{"node": "Buscar Leads Silenciosos", "type": "main", "index": 0}]]}, "Buscar Leads Silenciosos": {"main": [[{"node": "Qual Etapa?", "type": "main", "index": 0}]]}, "Qual Etapa?": {"main": [[{"node": "Msg Follow 1", "type": "main", "index": 0}], [{"node": "Msg Follow 2", "type": "main", "index": 0}], [{"node": "Msg Follow 3", "type": "main", "index": 0}]]}, "Msg Follow 1": {"main": [[{"node": "Enviar Follow-up", "type": "main", "index": 0}]]}, "Msg Follow 2": {"main": [[{"node": "Enviar Follow-up", "type": "main", "index": 0}]]}, "Msg Follow 3": {"main": [[{"node": "Enviar Follow-up", "type": "main", "index": 0}]]}, "Enviar Follow-up": {"main": [[{"node": "Atualizar Kanban", "type": "main", "index": 0}]]}}, "settings": {"executionOrder": "v1"}}
